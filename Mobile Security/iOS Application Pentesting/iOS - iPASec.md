# **Testing Local Data Storage**

---

### **1. Identify Sensitive Data**
- List the potentially sensitive data used by the application, such as:
  - **Authentication Tokens**
  - **User Credentials**
  - **Personally Identifiable Information (PII)**
  - **Encryption Keys**

---

### **2. Static Analysis**
Perform static analysis when you have access to the application's source code:

#### **a. Analyze Data Storage Locations**
- Review the codebase for the following APIs used for data storage:
  - `NSUserDefaults`
  - Core Data
  - SQLite Databases
  - File storage in the sandbox
  - Keychain

#### **b. Search for Misuse of Sensitive Data**
- Look for sensitive data stored in plaintext or without encryption.
- Avoid:
  - Hardcoding sensitive data into `.plist` files.
  - Storing sensitive keys in the app code.

#### **c. Verify Keychain Usage**
- Sensitive data should be stored using the Keychain API.
- Use `kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly` for better security.
- Ensure keys follow best practices, such as using envelope encryption (DEK + KEK).

---

### **3. Trigger App Functionality**
- Interact with the app to generate and store data locally:
  - Navigate all screens and perform all operations to ensure data is saved.
  - Pay attention to features like login, signup, saving user preferences, etc.

---

### **4. Dynamic Analysis**
Analyze how the app handles data storage during runtime:

#### **a. Test on a Jailbroken Device**
1. Connect the device and navigate to the app’s bundle directory:
   ```bash
   /var/mobile/Containers/Data/Application/$APP_ID/
   ```
2. Search for sensitive data using `grep`:
   ```bash
   grep -iRn "SENSITIVE_KEYWORD"
   ```

#### **b. Test on a Non-Jailbroken Device**
1. Use a tool like **iMazing** to extract app data:
   - Trigger the app functionality.
   - Extract the app using iMazing and analyze the `.zip` file.
2. Optionally, patch the app using tools like **Frida** or **objection** to explore the app's sandbox.

#### **c. Examine Data in Keychain**
- Use tools like **objection** to dump Keychain items:
   ```bash
   ios keychain dump
   ```

#### **d. Inspect Binary Cookies**
- Use objection to convert binary cookies to JSON:
   ```bash
   ios cookies get --json
   ```

#### **e. Review Property List (plist) Files**
- Use objection to extract plist files:
   ```bash
   ios plist cat userInfo.plist
   ```

---

### **5. Test in iOS Simulator**
For dynamic testing without a physical device:
1. Use **Xcode** to run the app in the iOS simulator.
2. Navigate to the simulator’s file system:
   ```bash
   cd ~/Library/Developer/CoreSimulator/Devices/$(
   ls -alht ~/Library/Developer/CoreSimulator/Devices | head -n 2 |
   awk '{print $9}' | sed -n '1!p')/data/Containers/Data/Application
   ```
3. Locate your app and grep for sensitive keywords.

---

### **6. Reporting Issues**
If sensitive data is stored insecurely:
- Document the storage location (e.g., plaintext in `NSUserDefaults`).
- Suggest encryption or secure alternatives (e.g., using the Keychain API).
- Provide remediation steps aligned with MASVS L1 or L2 requirements.

---

### **Tools for iOS Data Storage Testing**
- **Static Analysis**: Source code review, grep, IDE tools.
- **Dynamic Analysis**: iMazing, Frida, objection, Keychain dumper.
- **File Inspection**: Plist viewer, SQLite browser.

---

