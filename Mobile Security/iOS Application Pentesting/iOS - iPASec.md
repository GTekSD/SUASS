# iOS Application Penetration Testing

##### Contents
1. iOS Architecture
2. iOS Application Structure
3. Jailbreak
4. iOS Application Security Approach
5. Important Directories/Files to Look for in iOS
6. Extracting an IPA file
7. Running Static Analysis with MobSF
8. Setting Up Proxy
9. Introduction to OWASP Mobile Top 10
10. Tools Used
11. References

## 1. iOS Architecture

|iOS Architecture|
|----------------|
|**Cocoa Touch Layer**|
|`UlKit` `MapKit` `Event Kit` `Game Kit` `PushKit Kit` `Twitter` `iAd`|
|**Media Layer**|
|`UlKi Grphicst` `Core Graphics` `Core Animation` `Media Player` `AV Kit` `AV Foundation` `Core Audio` `Core Image` `Core Text` `OpenAL` `OpenGL` `Quartz`|
|**Core Services Layer**|
|`Healthkit` `WebKit` `Core data` `Foundation` `StoreKit` `Cloud Kit` `Address book` `Core Motion` `HomeKit` `Social` `Core Foundation`|
|**Core OS Layer**|
|`Core Bluetooth` `Accelerate` `External Accessory` `Security Services` `Local Authentication` `Directory Services` `Disk Arbitration` `System Configuration` `OpenCL`|
|**Kernel and Device Drivers Layer**|
|`BSD` `File System` `Mach` `Networking`|

The Table explains the different layers that are used between the Application and Hardware level to establish communication & perform different tasks.

1. **Kernel and Device Drivers:** It is the lowest layer of iOS which mainly includes the kernel and device drivers.
2. **Core OS Layer:** consists of technologies and frameworks which provide low-level services related to low-level hardware and networks. These include Accelerate Framework, Directory Services, System Configuration, memory management, file system handling and threads.
3. **Core Services Layer:** consists of core services that provide essential features to the application. It gives access to fundamental resources needed for an application. These services generally include Address book, Security, Social, foundation, Webkit, etc.
4. **Media Layer:** provides various multimedia services that can be utilized in the device, which basically enables all the audio-visual technologies (2D and 3D graphics, animations, image effects, professional-grade audio and video functionalities). It provides various functions such as Core Image, Core Audio, Core Text, etc.
5. **Cocoa Touch Layer:** is the topmost layer in the architecture and is also known as the Application Layer, which is primarily responsible for the application’s appearance. It exposes various APIs for programming the iPhone devices and provides access to the main system functions like Contacts, Camera, touch input, shares with other apps, push notifications, etc

### iOS Application Sandboxing 

- **Sandbox** is a directory on the iOS file system which allows applications to set up a local database on the device and separately segment from the other applications.
- It protects an application from other applications trying to make unauthorized access to any data that might be stored, such as passwords, payment information, and personal data like photos.
- To ensure there are no conflicts between the application, iOS assigns each app its own sandbox.

- **There are 3 types of sandboxes in an iDevice:**
  1. **Pre-installed App Directory** `/var/Application`: The applications that come pre-installed by default on the iDevice have their app files stored in this directory.
  2. **Bundle Directory** `/var/containers/Bundle/Application`: The "Bundle" directory, also known as the "IPA Container," contains all of the files that come with apps when downloaded from the Apple App Store. Also, downloaded from other locations as well. The files in this directory will remain the same throughout a particular application version.
  3. **Data Directory** `/var/mobile/Containers/data/Application`: The "Data" directory, also known as the "Local Data Storage Container," contains files the developer wants to keep. These are items that belong to the application while installed on the device 


## 2. iOS Application Structure

- iOS Applications use ".ipa" (iOS application archive) as a file extension, which is nothing but a compressed file.
- iOS applications are developed using X-code IDE and objective-c or Swift programming languages.
- The .ipa file structure is as follows:

      /Payload/
      /Payload/Application.app/
      /iTunesArtwork
      /iTunesArtwork@2x
      /iTunesMetadata.plist
      /WatchKitSupport/WK
      /META-INF

  1. The `/Payload/` folder contains all the application data.
  1. The Code signing is handled in the `/Payload/Application.app/` bundle directory.
  1. The `/iTunesArtwork` file is a 512×512 pixel PNG image used as the application's icon.
  1. The `/iTunesMetadata.plist` contains various bits of information, ranging from the developer's name and ID, the bundle identifier, copyright information, genre, the name of the application, release date, purchase date, etc.
  1. The `/META-INF` folder only contains metadata about what program was used to create the IPA.

- A closer look at the `IPA` file:
  - **MyApp:** contains the compiled application source code.
  - **Application:** Contains application icons.
  - **Info.plist:** Contains the configuration information, such as bundle ID, version number and application display name. This file is often checked while performing security assessments as it may contain interesting information or help us find some misconfigurations.
  - **Launch images:** Images showing the initial application interface in a specific orientation. The system uses one of the provided launch images as a temporary background until the application is fully loaded.
  - **MainWindow.nib:** Default interface objects that are loaded when the application is launched. Other interface objects are then either loaded from other nib files or created programmatically by the application.
  - **Settings.bundle:** Application-specific preferences to be displayed in the Settings app.
  - **Custom resource files:** Non-localized resources are placed in the top-level directory and localized resources are placed in language-specific subdirectories of the application bundle. Resources include nib files, images, sound files, configuration files, strings files, and any other custom data files the application uses.

-  A keychain is referred to as an encrypted container where an application can store sensitive information and only the authorized application can retrieve the data from it.

## 3. iOS Application Security Approach

1. Take a positive walkthrough from a developer’s perspective to know the application. 
    1. Ask for => Description, functionality, owners, version, application workflow, no.of static and dynamic modules, user roles, user credentials for each user role (minimum 3), limitations of the application.
    2. Check the walkthrough from our end. Verify given details are correct and working properly, if not set them as limitations.
    3. Get the "IPA" file from the client.
2. The application should be installed on a jailbroken device.
3. SSL pinning should be disabled in the "IPA" file provided.
4. Reasons: 
    1. To perform an end-to-end assessment, we need SSL pinning disabled and the application should be installed on a jailbroken device.
    2. If the application is installed on a jailbroken device, then only we can analyse all the internal packages with root privilege.
    3. If SSL pinning is disabled, then only we’ll be able to capture and analyse each request response of the application.
5. Check for sensitive information stored in plist files.
6. Check for sensitive information stored in local databases (.db, .sqlite, .sqlite3).
7. Check request response in burpsuite.

## 4. Important Directories/Files to Look for in iOS

### 1. Insecure Data Storage (.plist files)
  - **Plist File in the App Directory:**
    Plist (Property List) is a flexible and convenient format for storing application configuration data. It can be called as the manifest for an iOS application. It decides what icon to use for a bundle, what document types an app can support, and many other behaviours that have an impact outside the bundle itself. These files may contain sensitive data.
  - **NSUserDefaults:**
    Is one of the most common methods of saving user preferences and properties in an application using NsUserDefault. Even if you close the application and relaunch it, the NsUserDefault information persists. It stores data in "Plist" file format under the preference folder.
    1. Navigate to `/var/mobile/Containers/Data/Application` directory.
    2. Search for the application: `find | grep "<app_name>"`
    3. Navigate to the folder containing the application data: `cd <app_directory>`
    4. Search for ".plist" files: `find ./ -name "*.plist"`
    5. Now establish SFTP connection: `sftp root@<iOS_device_ip>`
    6. Retrieve the ".plist" file to the machine: `get -r /<path>/<filename.plist>`

### 2. Database Stored Locally without Encryption (.db/.sqlite/.sqlite3)
  - **Database Files in the App Directory:**
    Data required by an iOS application is often stored in SQLite databases. Testers should look for sensitive information stored in database files. Some extensions we can look for are ".db", ".sqlite" and ".sqlite3".
    1. Navigate to `/var/mobile/Containers/Data/Application` directory.
    2. Search for the application: `find | grep "<app_name>"`
    3. Navigate to the folder containing the application data: `cd <app_directory>`
    4. Search for ".plist" files: `find ./ -name "*.db", or find ./ -name "*.sqlite", or find ./ -name "*.sqlite3"`
    5. Now establish SFTP connection: `sftp root@<iOS_device_ip>`
    6. Retrieve the ".db" or "sqlite" or "sqlite3" file to the machine: `get -r /<path>/<filename.extension>`

### 3. Keychain 
Keychain is a password and certificate management system for iOS. It can be used to securely store sensitive bits of data, such as encryption keys and session tokens. Keychain is implemented as an SQLite database that can only be accessed through the Keychain APIs. It is common storage for all WiFi passwords as well as application data. 
All these items are stored in an encrypted database whose path is `/var/Keychains/keychain-2.db`.

## 5. Extracting an IPA file
1. The iDevice should be on the same network and connect to the iPhone by establishing SSH connection: `ssh root@<iOS_device_ip>` (Default Password is `Alpine`/`alpine`).
2. Navigate to the following directory: `/var/containers/Bundle/Application`
3. Search for the application: `find | grep "<app_name>"`
4. Navigate to the folder containing the application: `cd <app_directory>`
5. Create a directory with the name Payload: `mkdir Payload`
6. Copy the "appname.app" data into the Payload directory: `cp -r <appname.app> /Payload/`
7. Zip the Payload directory into IPA format: `zip -r /var/root/<appname.ipa> Payload/`
8. Now establish SFTP connection: `sftp root@<iOS_device_ip>`
9. Retrieve the ".ipa" file to the machine: `get -r /var/root/<appname.ipa>`

## 6. Running Static Analysis with MobSF
- After extracting the IPA file, the next step is to perform static analysis using MobSF.
  - Install MobSF: https://github.com/MobSF/Mobile-Security-Framework-MobSF
  - MobSF Documentation: https://mobsf.github.io/docs/#/
  - NOTE: To analyse iOS application, MobSF has to be installed on Mac OS or in any Linux OS.

- MobSF: Mobile Security Framework (MobSF) is an automated, open source, all-in-one mobile application (Android/iOS/Windows) pen-testing framework capable of performing static, dynamic and malware analysis.
- Steps to perform the static analysis:
  1. Run the MobSF Web Interface.
  2. Drop the IPA file and run static analysis.
  3. Once the static analysis is finished look for misconfigurations
 
## 7. Setting Up Proxy
1. In the Burp Suite, go to Proxy → Options → Proxy Listeners, add a listener to Specific Interfaces with IP address and port.
2. In iPhone device, enable proxy to manual in the wireless setting, add proxy details with IP address and port as specified in burp suite.
3. Open the browser, visit “http://burp” and download the CA certificate.
4. Go to Settings → Profiles → Install the CA certificate.
5. Navigate to Settings → General → About → Certificate Trust Settings and enable Portswigger CA Certificate.
6. Now turn “Intercept on” in the burp suite proxy and start capturing and analysing the request response.
