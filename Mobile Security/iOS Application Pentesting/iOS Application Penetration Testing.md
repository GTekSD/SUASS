# iOS Application Penetration Testing

## Setting Up the Environment for iOS Apps Penetration Testing
To perform the iOS apps penetration testing, first you need to jailbreak the iPhone. The jailbreaking process is explained in the previous section. You may pen test iOS apps either on the iPhone itself or using an iOS Simulator. To test apps on an iOS Simulator, you are advised to install the Xcode app development kit on your workstation (Mac). Setup a wireless network connection for the iOS device and the system installed with iOS simulator. Configure and launch iOS simulator in Xcode IDE. 

- **Xcode**  
  The iOS applications may be developed and tested by using the Xcode development kit that is recommended to be downloaded and installed on the iOS devices. This development kit consists of iOS SDK, built-in source code editor, GUI editor, Xcode IDE, iOS simulator, instruments, and the latest OS X and iOS SDKs. The iOS simulator is used for testing the iOS applications.

#### Environment Setup 
1. **Installing Xcode**  
   The Xcode may be installed either from app store or through the Apple developer site  
   <https://developer.apple.com/xcode>
2. **Installing iOS simulator**  
   1. Open Xcode, a welcome window appears, click on “Create a new Xcode project.”
   2. “Choose a temple for your new project” window appears. Under “iOS” tab select “Single View Application” and click Next.
   3. “Choose options for your new project” window appears. Fill in the fields, “Product Name” and leave other fields as default and click Next and then Create.
   4. The profile that you have created appears on the screen. Below Deployment Info settings, choose a device from the “Devices” options.
   5. Click on the “iPhone” tab on the top, a list will be displayed. You may choose a device you want to install.
   6. Click on the play icon (first icon from the left) to build and run the current scheme.
   7. “Build succeeded” notification appears. A simulator window appears, it takes some time to install and start a device.
3. Installing iOS app in the simulator
   1. Open a terminal window.
   2. Use the following command to get a list of available simulators on Xcode:
   ```
   $ xcrun instruments -s devices
   ```
   3. Select the device on which you want to test your app:
      ```
      $ xcrun instruments -w AB13F549-1AF6-47B9-B46F-48B601E14212
      ```
   4. In the terminal window, navigate to the folder where you have placed the target app that you want to install and then execute the following command:
      ```
      $ codesign -fs - <app_name.app>
      ```
   5. Now, execute the following command to install the target app in the running simulator:
      ```
      $ xcrun simctl install booted <app_name.app>
      ```
   6. After the completion of the installation, an app icon appears on the simulator. You may tap the icon to run the app and test it against various exploits.
    
Ters use iOS simulator to test an iOS app security and depending upon the results, further recommend some necessary changes in the app to enhance the security of the app.

#### Screenshot of iOS simulator
![Screenshot of iOS simulator](https://github.com/user-attachments/assets/1a93baab-db51-4c16-8d06-4b13f501fa21)

![SimulatorWithXcode-1](https://github.com/user-attachments/assets/1d149ffa-6f19-4c1c-9236-5ce7d791d16c)

## Before IPA Penetration Testing
The necessary prerequisites that are recommended to be installed on your system, before starting the penetration testing on the target iOS app are given below:

### Cydia 
Source: <https://cydiainstaller.net>

Cydia is an application software for Apple devices. It contains a package with jailbreaking tools, such as: Pangu or evasi0n. Cydia packet manager is used for installing restricted apps in the iOS device, after the jailbreaking process. It comes as a package with a jailbreaking tool, such as Pangu (<http://pangu.io>) or evasi0n (<http://www.evasion7.com>).

### Gdb 
Source: <https://www.gnu.org>

GDB, the GNU Project debugger, is used to analyze the runtime behavior of an iOS app. It allows you to see the back end process of a program while it is running and the reason of it getting crashed while running.

### Class Dump 
Source: <http://stevenygard.com>

Class Dump is a command-line utility for examining the Objective-C runtime information stored in Mach-O files. It generates declarations for the classes, categories, and protocols. This is the same information provided by using “otool -ov,” but presented as normal Objective-C declarations, so it is much more compact and readable.

### OpenSSH 
Source: <http://www.openssh.com>

OpenSSH is a connectivity tool for remote login with the SSH protocol. It encrypts all traffic to eliminate eavesdropping, connection hijacking, and other attacks. In addition, OpenSSH provides a large suite of secure tunneling capabilities, several authentication methods, and sophisticated configuration options. 

It is a Secure Shell based suite that is used for secure communication. This may be installed via Cydia and comes with a default username and a password. It is always recommended to change the default username and the password.

## Identify whether iPhone is Jailbroken or not
Jail breaking is the process of removing security mechanisms set by Apple to prevent malicious code from running on the device. It provides root access to the operating system and removes sandbox restrictions. Thus jailbreaking, such as rooting, comes along with many security and other risks to the iOS device. Jail breaking may create backdoors to the malware and Trojan that allows access to personal details of the target device. Moreover, your system may become more error-prone and various stability issues may arise in the device.

You need to perform jail breaking to find the vulnerabilities that could be exploited to get the access to the device. Perform jailbreaking to bypass user limitations as set by Apple, such as modifying the OS, attaining admin privileges, and installing unofficially approved apps via “side loading.” 

Jailbreaking **creates new files** on the device. Most common files that **exist** when iPhone is jailbroken are listed below:
  ```
  /private/var/stash 
  /private/var/lib/apt 
  /private/var/tmp/cydia.log 
  /private/var/lib/cydia 
  /private/var/mobile/Library/SBSettings/Themes 
  /Library/MobileSubstrate/MobileSubstrate.dylib 
  /Library/MobileSubstrate/DynamicLibraries/Veency.plist 
  /Library/MobileSubstrate/DynamicLibraries/LiveClock.plist 
  /System/Library/LaunchDaemons/com.ikey.bbot.plist 
  /System/Library/LaunchDaemons/com.saurik.Cydia.Startup.plist 
  /var/cache/apt 
  /var/lib/apt 
  /var/lib/cydia 
  /var/log/syslog 
  /var/tmp/cydia.log 
  /bin/bash 
  /bin/sh 
  /usr/sbin/sshd
  /usr/libexec/ssh-keysign 
  /usr/sbin/sshd 
  /usr/bin/sshd 
  /usr/libexec/sftp-server 
  /etc/ssh/sshd_config 
  /etc/apt 
  /Applications/Cydia.app 
  /Applications/RockApp.app 
  /Applications/Icy.app 
  /Applications/WinterBoard.app
  /Applications/SBSettings.app 
  /Applications/MxTube.app 
  /Applications/IntelliScreen.app 
  /Applications/FakeCarrier.app 
  /Applications/blackra1n.app
  ```
#### Aollowing are different ways to identify whether the iPhone is jailbroken or not: 
- Look for these **files** to determine whether the target iPhone is jailbroken or not. 
- Check for the **permissions** for the root partition; if it has read/write permissions, then the device is jailbroken.
- Check the **size** of `/etc/fstab` file, as jailbreaking of the device increases the size of this file.
- Check whether applications may **modify files** outside of its sandbox. 
- Check whether the **OpenSSH service** is running on the device. 
- Check whether **Cydia** is installed on the device and also check for the **Cydia URL scheme** (`cydia://`) used while browsing applications.

## Inspect the Plist for Sensitive Information
Source: https://developer.apple.com 

Property List (plist) is a structured text file that contains essential user preferences and the configuration information of the application. It undergoes UTF-8 encoding and the contents are structured through XML. 

The root XML node is the Dictionary that holds a set of keys and values having detailed aspects of the bundle. The system makes use of this set of keys to obtain information about your app and the way it was configured. Therefore, all the bundled executables (plug-ins, frameworks, and apps) are expected to contain an information property list file. 

Plist has two formats: ASCII and binary format. The ASCII file may be easily read by any standard text editor as the data is presented as XML. But, to read binary file, you are advised to use Property List Editor (plist editor) that may convert the binary file into ASCII format. 

You are advised to inspect all the Plist files for collecting sensitive information, such as usernames, passwords, user’s personal information, session cookies, etc. Also, you may use Plist editors, such as plutil to view or modify all the Plist files available under application’s home directory. 

### Viewing or Editing Plist Files using Property List Editors (Plist editors) 
To view or edit the contents of property list file, select the <project>-Info.plist file in your Xcode project to display the property list editor, as shown below:

<img width="680" alt="xcode_infoplist_editor_2x" src="https://github.com/user-attachments/assets/3540d4f3-fb86-478b-94ec-c1a453c40e1f" />

## Investigate the Keychain Data Storage 
The Keychain Data Storage is a data storage container that stores the user data, such as passwords, keys, certificates, etc., by using the keychain service library. This sensitive information may be read from/write to the key chains. A keychain is a collection of various keychain items, which further contains sensitive data encrypted securely and along with their associated attributes. These keychain items are categorized into five types based on their type of data; and stored in four types of tables. The keychain item types are shown below:
- kSecClassGenericPassword: Represents password types of data 
- kSecClassInternetPassword: Represents internet password type of data 
- kSecClassCertificat: Represents certificate type of data 
- kSecClassKey: Represents keys 
- kSecClassIdentity: Represents digital identity

The keychain items are stored in the following four types of tables: 
- genp—For storing the generic passwords 
- inet—For storing the internet passwords 
- cert and keys—For storing certificates, keys, and digital identity

As we discussed before, the keychain item class contains attributes that describes the nature of the encrypted data; these attributes are used to map the columns of the table. The keychain data storage is hardware specific, which means the data inside the keychain of a system may only be accessible through that device only. It is encrypted with a unique key that cannot be used for other devices. The operating system restricts the applications from accessing the keychain data of another application. A keychain-access-group could be created to share the keychain data of various applications that are grouped together. The application entitlements are stored inside the application binary and can be accessed through grep or sed command by connecting the jailbroken iPhone to the SSH.

To know the iOS application entitlements, move to the directory of an application, and run the command shown below: 
```
sed -n ‘//,/<\/dict>/p’ [AppDirectory]/[ApplicationBinary] [/CODE]
```
Provide proper information at the AppDirectory and ApplicationBinary in the above command and then run the command. However, keychains are broken at each level; therefore, the tester needs to assess its security in order to find weaknesses (if any) that exist in it. Copy the `keychain2.db` file located at `/private/var/Keychains/keychain-2.db`. In iPhone and on your workstation, use SQLite Database Browser to open it as shown in the screenshot given below:

![Screenshot of SQLite Database Browser showing keychain database](https://github.com/user-attachments/assets/52e5cda9-2997-4b8a-aefa-ead69dcf1ee0)

You may use iOSKeychain Analyzer to view the contents of the iOS keychain to identify the secrets stored, as well as analyze these secrets from a security standpoint.

### iOSKeychain Analyzer 
Source: https://github.com/Foundstone/ios-keychain-analyzer

iOSKeychain Analyzer accomplishes the following two main functionalities: 
- Extract and export iOS simulator keychain contents
- Analyze the iOS simulator keychain contents from a security standpoint
This tool is intended for pen testers as they test iOS application within the iOS simulator. Often the application will use the iOS keychain and from a testing standpoint it is necessary to inspect the contents of the keychain. The tool allows viewing the contents of the iOS "keychain" to identify the secrets being stored as well as analyzes these secrets from a security standpoint.

#### The following steps explain the usage of the tool: 
1. First install and configure the application that you are testing within the iOS simulator.
2. If iOS Keychain Analyzer is not installed within the simulator then install it.
3. Launch the iOS Keychain Analyzer and export/analyze the keychain data.
4. It is recommended to create the following two data export/report files in the application - `/<iOS_Keychain_Analyzer_Installation_Folder>/Library/Caches/DataAndAnalysisReports`. E.g. `/Users/<User_Name>/Library/Application Support/iPhone Simulator/5.1/Applications/01EFB1DB-4A47-45A1-B692-F88996FAC4F8/Library/Caches/DataAndAnalysisReports/`
   1. iOSKeychainDataViewer.htm - This report displays the entire contents of the keychain in a readable format. The raw keychain contents are stored in JSONP format in the "KeychainDataExport.jsonp" file
   2. iOSKeychainAnalysisReportViewer.htm - This report displays the keychain data analysis report in a readable format. The raw analysis report can be found in the "KeychainAnalysisReport.jsonp"

#### Analyze the iOS Simulator Keychain Contents from a Security Standpoint
The tool also analyzes the contents of iOS keychain from the perspective of the following checks -

1. **Weak Password Check** - All password items that have a length less than 8 characters, or is not alphanumeric or does not contain a special character is flagged
2. **Weak Authentication Method Check** - All password items that are configured to be used with weak authentication methods such as HTTP Basic and HTTP Digest are flagged
3. **Weak Protocol Check** - All passwords that are configured to use insecure protocols such as HTTP, FTP etc. are flagged
4. **Weak Key Length Check** - All symmetric keys with key length less than 128 bits and all asymmetric keys with key length less than 1024 bits are flagged
5. **Insecure Accessibility Check** - All items that can be accessed insecurely (irrespective of whether the device is locked or not) are flagged

#### Follow the steps given below to investigate the keychain data storage using iOSKeychain Analyzer:
1. Tap the application to open the iOSKeychain Analyzer app as shown the figure below:
  ![Main Page](https://raw.github.com/Foundstone/ios-keychain-analyzer/master/iOSKeychainAnalyzer/Screenshots/Main_Page.png)

2. Tap the Analyze Keychain Data option to open the following screen: 
  ![Analyze Keychain Data](https://raw.github.com/Foundstone/ios-keychain-analyzer/master/iOSKeychainAnalyzer/Screenshots/Analyze_Keychain_Data.png)

3. Export the keychain data page as shown below:
  ![Export Keychain Data](https://raw.github.com/Foundstone/ios-keychain-analyzer/master/iOSKeychainAnalyzer/Screenshots/Export_Keychain_Data.png)

4. Now you will get the reports of the keychain data export and analysis as shown in the screenshot below:
  ![Keychain Data Export](https://raw.github.com/Foundstone/ios-keychain-analyzer/master/iOSKeychainAnalyzer/Screenshots/Keychain_Data_Export.png)

5. Keychain Analysis Report
  ![Keychain Analysis Report](https://raw.github.com/Foundstone/ios-keychain-analyzer/master/iOSKeychainAnalyzer/Screenshots/Keychain_Analysis_Report.png)

## Check the iPhone Logs for Leakage of Sensitive Information (Insecure Logging)
Device logs contain information from the devices which consists of sensitive data logged from various application. However, developers usually forget to erase these records during the release of an application. Therefore, auditing the logs is essential to avoid leakage of sensitive information.

You may obtain iPhone logs by using the Xcode IDE by connecting the device to the system. In the menu bar, go to Windows -> Organizer, and from the Organizer, go to Devices tab. You may see many options listed on the left-side of the navigation pane; from there click Device logs as shown in the screenshot given below:

<img width="639" alt="Organizer-Devices" src="https://github.com/user-attachments/assets/006e508d-dd02-4a74-885e-256030dbac27" />

![image](https://github.com/user-attachments/assets/62eccb4f-0f97-477e-9112-8c73509982e5)

This Device logs contain complete information about the logs from the devices that are connected to Xcode. From here you may check the iPhone logs for leakage of sensitive information. Auditing the logs is one of the best ways to avoid leakage of sensitive information.

## Explore and Look for Sensitive Files in iOS File System
The iOS file system is one of the important resources that may be accessed by all the processes, on both jailbroken and non-jailbroken phones. It is used to manage and store data files, applications, and the files related to iOS. 

You need to explore the iOS file system and try to understand, how the directories and sub-directories are organized in it as well as how to extract information from the sensitive files. This helps you in detecting security flaws and vulnerabilities that exist in the iOS file system. To explore and look for sensitive files in iOS file system, connect the device to the workstation and browse the iPhone file system with iExplorer.

### iExplorer 
Source: https://macroplant.com 

iExplorer may directly access files and folders on your iDevice and may browse your device's files in existing iTunes backups. iExplorer puts your files and folders at your fingertips so you may explore and use media, app directories, and even the device's root. It lets you access iPhone files from PC or Mac easily, and you may even mount your device's directories as a native disk in Windows Explorer (PC) or Finder (Mac). 

Follow the below steps to explore and view files in iOS file system using iExplorer: 
1. Connect the iPhone to your system.
2. Open the iExplorer by double-clicking on its icon.
3. Once it is opened, you will see a window with different categories, such as Music, Messages, Contacts, etc.
4. Choose a category of the files you want to access.
5. Now, the list of files are displayed on the screen.

## Inspecting SQLite Databases
SQLite is an in-process software library having server less, zero-configuration, self-contained, transactional SQL database engine. This database does not require any connection compared to other databases. It is self-contained as it does not require external libraries or special facilities or tools to build.

All iOS devices use SQLite for storing the information and as it provides lightweight and robust relational DB engine that could embed with all the iOS applications easily. Through this, the applications are able to access the database very easily and fast. All the applications store their information in the form of plaintext and are not encrypted. So, it would be easy to access the information from the application’s database. It is even easy to recover the deleted information by using various approaches. 

As a pen tester you need to inspect SQLite databases to identify whether any sensitive user’s information is leaked or not. Testing SQLite databases also helps you in identifying vulnerabilities that lead to various injection attacks. 

Follow the steps given below to inspect the SQLite database: 
- Find the actual location of that app’s SQLite databases 
- Navigate to Library -> Application Support -> iPhone Simulator -> [version] -> Applications -> Documents
- Run `sqlite3` command with target .sqlite file
  ```
  $ sqlite3 _alloy_.sqlite
  ```
You may also use SQLiteSpy to view SQLite database files on iPhone.
### SQLiteSpy 
Source: https://www.yunqa.de 

SQLiteSpy is a fast and compact GUI database manager for SQLite. It reads SQLite3 files and executes SQL against them. Its graphical user interface makes it very easy to explore, analyze, and manipulate SQLite3 databases. 

#### Features: 
- **Database at a Glance:** The schema treeview displays all items contained in a database, including tables, columns, indexes, and triggers.
- **Grid Cell Editing:** Table cells are editable in the grid.
- **Data Type Display:** The native SQL data types are displayed with different background colors to help detect type errors. Type errors may cause performance degradation or wrong SELECT result sets if NULL values are confused with empty strings.
- **Full Unicode:** SQLiteSpy fully supports SQLite's Unicode capabilities. Data display and entry is completely realized as Unicode, including SQL commands.
- **Time Measurement:** SQL execution time is automatically measured and displayed to help optimize queries.
- **Built-in SQLite Engine:** SQLiteSpy comes as a single file executable with the SQLite database engine already build into the application.

![image](https://github.com/user-attachments/assets/a2de85fd-8657-420a-9341-99bcf8b6d43c)

## Inspect Error Application Logs
Logs store useful information about the applications such as cookies, authentication tokens, etc. The log information of one application cannot be accessed by another application. But the error logs of an application can be used by another application. You can take this opportunity to read the sensitive information about the application that created the error log. These error logs are recommended to be inspected and are recommended to be kept away from the malicious hackers. You may use iPhone Configuration Utility’s console to inspect the error logs.

You may view Syslog files by navigating to `/private/var/log/syslog` and view error logs of iPhone. Use the following commands to view Crash Logs: 
- On Mac
  `~/Library/Logs/CrashReporter/MobileDevice/<DEVICE_NAME>`
- On Windows 8
  `C:\Users\AppData\Roaming\Apple computer\Logs\CrashReporter\MobileDevice\<your iPhone’s name>\`

![iOS showing File Manager](https://github.com/user-attachments/assets/9dbcf08d-7599-428c-b3b2-b483bfe6e122)

Logs help you to identify and detect the source of system issues and help to predict future problems. You may use iPhone Configuration Utility’s console to see the error logs. 

Follow the steps below to view the console logs using iPhone configuration utility: 
1. Install the iPhone Configuration Utility
2. Connect the iPhone to the system
3. Open the iPhone Configuration Utility and check the console logs as shown in the screenshot given below:
