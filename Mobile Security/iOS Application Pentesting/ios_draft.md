# iOS Penetration Testing Guide

## 1. iOS Architecture

The diagram illustrates the various layers utilized between the Application and Hardware levels for communication and performing different tasks.

1. **Kernel and Device Drivers:** The lowest layer of iOS, including the kernel and device drivers.

2. **Core OS Layer:** Comprises technologies and frameworks offering low-level services related to hardware and networks. Includes Accelerate Framework, Directory Services, System Configuration, memory management, file system handling, and threads.

3. **Core Services Layer:** Consists of core services providing essential features to applications. Access to fundamental resources needed for applications, such as Address book, Security, Social, foundation, Webkit, etc.

4. **Media Layer:** Provides multimedia services for audio-visual technologies, including 2D and 3D graphics, animations, image effects, professional-grade audio, and video functionalities. Functions include Core Image, Core Audio, Core Text, etc.

5. **Cocoa Touch Layer:** The topmost layer, also known as the Application Layer, responsible for the application's appearance. Exposes various APIs for programming iPhone devices and provides access to main system functions like Contacts, Camera, touch input, sharing with other apps, push notifications, etc.

## iOS Application Sandboxing

- **Sandbox:** A directory on the iOS file system that allows applications to set up a local database on the device, separately segmented from other applications.
  
- Protects an application from unauthorized access attempts by other applications to data such as passwords, payment information, and personal data like photos.

- iOS assigns each app its own sandbox to avoid conflicts.

- **Types of Sandboxes in an iDevice:**
  1. **Pre-installed App Directory (/var/Application):** Contains app files for pre-installed applications on the iDevice.
  
  2. **Bundle Directory (/var/containers/Bundle/Application):** Also known as the "IPA Container," contains files that come with apps downloaded from the Apple App Store. Files remain the same throughout a particular application version.
  
  3. **Data Directory (/var/mobile/Containers/data/Application):** Also known as the "Local Data Storage Container," contains files the developer wants to keep. These are items that belong to the application while installed on the device.


# iOS Penetration Testing Guide (Continued)

## Examining the "IPA" File

When conducting iOS penetration testing, it's essential to delve into the structure of the "IPA" (iOS application archive) file to gather valuable information.

### Information About the Program Used to Create the IPA

- Details about the tool or program used to create the IPA.

### A Closer Look at the "IPA" File:

1. **MyApp:** Contains the compiled application source code.

2. **Application:** Holds application icons.

3. **Info.plist:** Contains configuration information, such as bundle ID, version number, and application display name. This file is crucial during security assessments, potentially revealing interesting information or misconfigurations.

4. **Launch Images:** Images displaying the initial application interface in a specific orientation. The system uses one of the provided launch images as a temporary background until the application is fully loaded.

5. **MainWindow.nib:** Default interface objects loaded when the application launches. Other interface objects are either loaded from other nib files or created programmatically by the application.

6. **Settings.bundle:** Contains application-specific preferences displayed in the Settings app.

7. **Custom Resource Files:** Non-localized resources are placed in the top-level directory, and localized resources are in language-specific subdirectories. Resources include nib files, images, sound files, configuration files, strings files, and any other custom data files used by the application.

8. **Keychain:** An encrypted container where an application can store sensitive information. Only the authorized application can retrieve data from it.


# iOS Penetration Testing Guide (Continued)

## 3. Jailbreak

Jailbreaking is a method used to lift user restrictions imposed by the manufacturer on iOS devices. Various jailbreaking methods exist, and they may differ based on iOS versions. Different types of jailbreak include:

1. **Untethered Jailbreak:**
   - Permanent jailbreak; the device remains jailbroken even after a reboot.

2. **Tethered Jailbreak:**
   - Temporary jailbreak; the device loses its jailbroken state after a reboot.

3. **Semi-tethered Jailbreak:**
   - Allows the device to start up on its own but lacks a patched kernel, preventing the execution of modified code.

4. **Semi-untethered Jailbreak:**
   - Similar to untethered jailbreak but requires an app on the device to re-jailbreak after each boot.

## 4. iOS Application Security Approach

1. **Positive Walkthrough:**
   - Gain insights from a developer's perspective.
     - Obtain information on description, functionality, owners, version, application workflow, static and dynamic modules, user roles, and user credentials for each role (minimum 3).
     - Verify and check the given details; set any discrepancies as limitations.

2. **Device Setup:**
   - Install the application on a jailbroken device.

3. **SSL Pinning:**
   - Disable SSL pinning in the provided "IPA" file.

4. **Reasons:**
   - Enable end-to-end assessment with SSL pinning disabled and the application installed on a jailbroken device.
   - Analyze internal packages with root privilege on a jailbroken device.
   - Capture and analyze each request/response of the application with SSL pinning disabled.

5. **Check for Sensitive Information:**
   - Examine plist files for sensitive information.

6. **Check Local Databases:**
   - Investigate local databases (.db, .sqlite, .sqlite3) for sensitive information.

7. **Burp Suite Analysis:**
   - Inspect request/response in Burp Suite.


# 5. Important Directories/Files to Look for in iOS

## 1. Insecure Data Storage (.plist files)

- **Plist File in the App Directory:**
  - Plist (Property List) is a format for storing application configuration data.
  - It may contain sensitive data influencing app behavior outside the bundle.
  - Navigate and retrieve files:
    ```bash
    find /var/mobile/Containers/Data/Application -name "*.plist"
    sftp root@<iOS_device_ip>
    get -r /<path>/<filename.plist>
    ```

- **NSUserDefaults:**
  - Common method for saving user preferences.
  - Information persists even after application restart.
  - Navigate and retrieve files:
    ```bash
    find /var/mobile/Containers/Data/Application -name "*.plist"
    sftp root@<iOS_device_ip>
    get -r /<path>/<filename.plist>
    ```

## 2. Database Stored Locally without Encryption (.db/.sqlite/.sqlite3)

- **Database Files in the App Directory:**
  - Look for sensitive information in SQLite databases.
  - Extensions to search: ".db", ".sqlite", ".sqlite3".
  - Navigate and retrieve files:
    ```bash
    find /var/mobile/Containers/Data/Application -name "*.db" -or -name "*.sqlite" -or -name "*.sqlite3"
    sftp root@<iOS_device_ip>
    get -r /<path>/<filename.extension>
    ```

- **Keychain:**
  - Password and certificate management system.
  - Stores encryption keys, session tokens, and WIFI passwords.
  - Encrypted database path: "/var/Keychains/keychain-2.db".

# 6. Extracting an IPA file

1. Establish SSH connection: `ssh root@<iOS_device_ip>` (Default Password is Alpine/alpine).
2. Navigate to `/var/containers/Bundle/Application`.
3. Search for the application: `find | grep "<app_name>"`.
4. Navigate to the folder containing the application: `cd <app_directory>`.
5. Create a directory named Payload: `mkdir Payload`.
6. Copy the "appname.app" data into the Payload directory: `cp -r <appname.app> /Payload/`.
7. Zip the Payload directory into IPA format: `zip -r /var/root/<appname.ipa> Payload/`.
8. Establish SFTP connection: `sftp root@<iOS_device_ip>`.
9. Retrieve the ".ipa" file to the machine: `get -r /var/root/<appname.ipa>`.


# 7. Running Static Analysis with MobSF

After extracting the IPA file, the next step is to perform static analysis using MobSF.

**Install MobSF:**
- [MobSF GitHub Repository](https://github.com/MobSF/Mobile-Security-Framework-MobSF)
- [MobSF Documentation](https://mobsf.github.io/docs/#/)

**NOTE:** To analyze iOS applications, MobSF must be installed on macOS or any Linux OS.

**MobSF - Mobile Security Framework:**
Mobile Security Framework (MobSF) is an automated, open-source, all-in-one mobile application (Android/iOS/Windows) pen-testing framework capable of performing static, dynamic, and malware analysis.

**Steps to Perform Static Analysis:**

1. Run the MobSF Web Interface.
2. Drop the IPA file and run static analysis.
3. Once the static analysis is finished, look for misconfigurations.


# 09. Introduction to OWASP Mobile Top 10

1. **Improper Platform Usage:**
   - Refers to the improper or mismanaged use of mobile platform security controls.
   - Attackers can abuse security control features provided by the iOS platform.
   - Examples include file permissions, microphone permissions, biometric authentication (Touch/Face ID), keychain, and platform permissions.

2. **Insecure Data Storage:**
   - iOS applications may store data locally, and if not encrypted, it can be exploited if an attacker has physical device access.

3. **Insecure Communication:**
   - Due to improper implementation of communication standards (e.g., over HTTP), attackers can steal sensitive information or perform Man-in-the-Middle attacks.
   - SSL pinning ensures secure data transfer between a web server and client.

4. **Insecure Authentication:**
   - Weak authentication checks or manipulation of login/authentication requests can lead to unauthorized access.

5. **Insufficient Cryptography:**
   - Lack of strong cryptography can allow attackers to access encrypted data and gain sensitive information.

6. **Insecure Authorization:**
   - Weak implementation of authorization can result in improper authorization, allowing low-level users to access high privileged user information.

7. **Client Code Quality:**
   - Poor code quality can lead to attackers passing crafted inputs, causing malfunctions and exploitable scenarios.

8. **Code Tampering:**
   - Attackers exploit code modification via malicious forms. Code tampering checks prevent modification and injection of malicious code.

9. **Reverse Engineering:**
   - Attackers decompile mobile applications to understand logic and function implementations. Code obfuscation prevents code reading.

10. **Extraneous Functionality:**
    - Developers may keep codes for backend server access, error analysis, staging information, etc.
    - Attackers explore hidden functionalities, and this code may carry sensitive information.

## 10. Tools Used
- Filza
- Plist Editor
- DB Browser (SQLite)
- Mobile Security Framework (MobSF)
- Burp Suite
- FileZilla
- iMazing
- Frida
- Objection
